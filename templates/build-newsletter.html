<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Build Newsletter - HRF Newsletter Generator</title>
    <style>
        /* (CSS from user sample, unchanged) */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 2rem 0;
        }
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: 2rem;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #333;
            margin-bottom: 2rem;
            text-align: center;
            font-size: 2.5rem;
        }
        h2 {
            color: #555;
            margin-bottom: 1.5rem;
            margin-top: 2rem;
            font-size: 1.8rem;
            border-bottom: 2px solid #667eea;
            padding-bottom: 0.5rem;
        }
        h3 {
            color: #666;
            margin-bottom: 1rem;
            margin-top: 1.5rem;
            font-size: 1.4rem;
        }
        h4 {
            color: #777;
            margin-bottom: 0.8rem;
            margin-top: 1rem;
            font-size: 1.2rem;
        }
        .info-section {
            background: #f8f9fa;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }
        .info-row {
            display: flex;
            margin-bottom: 1rem;
        }
        .info-label {
            font-weight: 600;
            color: #555;
            min-width: 150px;
        }
        .info-value {
            color: #333;
        }
        .language-tag {
            display: inline-block;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 600;
            margin-right: 8px;
        }
        .form-group {
            margin-bottom: 1.5rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: #555;
            font-weight: 600;
        }
        .form-group input,
        .form-group select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
        }
        .file-input-group {
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .file-input-group input[type="text"] {
            flex: 1;
        }
        .file-btn {
            background: #6c757d;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
        }
        .file-btn:hover {
            background: #5a6268;
        }
        .hidden-file-input {
            display: none;
        }
        .container-section {
            border: 2px solid #e1e5e9;
            border-radius: 10px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            background: #fafbfc;
        }
        .cta-section {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            background: white;
        }
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 15px 30px;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s ease;
            width: 100%;
            margin-top: 2rem;
        }
        .btn:hover {
            transform: translateY(-2px);
        }
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        .error {
            border-color: #dc3545 !important;
            background-color: #fff5f5;
        }
        .error-message {
            color: #dc3545;
            font-size: 14px;
            margin-top: 5px;
        }
        .loading {
            display: none;
            text-align: center;
            margin-top: 1rem;
            color: #666;
        }
        .spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-right: 10px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .back-link {
            display: inline-block;
            color: #667eea;
            text-decoration: none;
            margin-bottom: 1rem;
            font-weight: 600;
        }
        .back-link:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
    <div class="container">
        <a href="/" class="back-link">‚Üê Back to Country Selection</a>
        <h1>Build Newsletter</h1>
        <!-- Country and Languages Info -->
        <div class="info-section">
            <div class="info-row">
                <span class="info-label">Country:</span>
                <span class="info-value" id="selectedCountry">-</span>
            </div>
            <div class="info-row">
                <span class="info-label">Languages spoken:</span>
                <div class="info-value" id="selectedLanguages">-</div>
            </div>
        </div>
        <form id="newsletterBuildForm">
            <!-- Hero Section -->
            <div class="container-section">
                <h2>Hero</h2>
                <div class="form-group">
                    <label for="heroImage">Image (JPG or PNG):</label>
                    <div class="file-input-group">
                        <input type="text" id="heroImage" placeholder="Enter image URL or select file">
                        <button type="button" class="file-btn" onclick="triggerFileInput('heroImageFile')">Select File</button>
                        <input type="file" id="heroImageFile" class="hidden-file-input" accept=".jpg,.jpeg,.png">
                    </div>
                    <div class="error-message" id="heroImageError"></div>
                </div>
                <div class="form-group">
                    <label for="heroImageAlt">Image alt:</label>
                    <input type="text" id="heroImageAlt" placeholder="e.g., 'Protesters holding signs for human rights'">
                </div>
                <div class="form-group">
                    <label for="heroHeadline">Headline:</label>
                    <input type="text" id="heroHeadline" placeholder="e.g., 'Breaking: Major Human Rights Victory in Supreme Court'">
                </div>
                <div class="form-group">
                    <label for="heroDescription">Description:</label>
                    <input type="text" id="heroDescription" placeholder="e.g., 'A landmark decision that will impact millions of people worldwide...'">
                </div>
                <div class="form-group">
                    <label for="learnMoreUrl">Learn more link URL (optional):</label>
                    <input type="text" id="learnMoreUrl" placeholder="https://example.com/article">
                    <div class="error-message" id="learnMoreUrlError"></div>
                </div>
                <div class="form-group">
                    <label for="ctaCount">Call To Action URLs:</label>
                    <select id="ctaCount">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                    </select>
                </div>
                <div id="ctaSections"></div>
            </div>
            <!-- Stories Section -->
            <div class="form-group">
                <label for="storyCount">How many stories? (0, 1 or 2):</label>
                <select id="storyCount">
                    <option value="0">0</option>
                    <option value="1">1</option>
                    <option value="2">2</option>
                </select>
            </div>
            <div id="storySections"></div>
            <button type="submit" class="btn" id="generateBtn">Generate Newsletter(s)</button>
            <div class="loading" id="loadingDiv">
                <div class="spinner"></div>
                <span>Generating newsletter(s)...</span>
            </div>
        </form>
    </div>
    <script>
        // (JS from user sample, unchanged)
        const urlParams = new URLSearchParams(window.location.search);
        const selectedCountry = urlParams.get('country');
        let selectedLanguages = [];
        document.getElementById('selectedCountry').textContent = selectedCountry || 'Not selected';
        async function fetchCountryLanguages() {
            try {
                const response = await fetch('/api/countries');
                const countries = await response.json();
                if (selectedCountry && countries[selectedCountry]) {
                    const languagesDict = countries[selectedCountry].languages || {};
                    selectedLanguages = Object.keys(languagesDict);
                    const languagesHtml = selectedLanguages.map(lang => 
                        `<span class="language-tag">${lang}</span>`
                    ).join('');
                    document.getElementById('selectedLanguages').innerHTML = languagesHtml;
                }
            } catch (error) {
                console.error('Error fetching country languages:', error);
                document.getElementById('selectedLanguages').innerHTML = 'Error loading languages';
            }
        }
        fetchCountryLanguages();
        function isValidUrl(string) {
            try {
                new URL(string);
                return true;
            } catch (_) {
                return false;
            }
        }
        function triggerFileInput(fileInputId) {
            document.getElementById(fileInputId).click();
        }
        function setupFileInput(textInputId, fileInputId) {
            const fileInput = document.getElementById(fileInputId);
            const textInput = document.getElementById(textInputId);
            fileInput.addEventListener('change', function(e) {
                if (e.target.files.length > 0) {
                    const file = e.target.files[0];
                    const fileName = file.name;
                    textInput.value = `üìÅ ${fileName}`;
                    textInput.setAttribute('data-file-selected', 'true');
                    const reader = new FileReader();
                    reader.onload = function(e) {
                        textInput.setAttribute('data-file-data', e.target.result);
                        console.log(`File ${fileName} converted to base64 (${Math.round(e.target.result.length/1024)}KB)`);
                    };
                    reader.onerror = function() {
                        console.error(`Failed to read file: ${fileName}`);
                        textInput.value = '';
                        textInput.removeAttribute('data-file-selected');
                        textInput.removeAttribute('data-file-data');
                    };
                    reader.readAsDataURL(file);
                }
            });
        }
        function setupUrlValidation(inputId, errorId) {
            const input = document.getElementById(inputId);
            const errorDiv = document.getElementById(errorId);
            input.addEventListener('blur', function() {
                const value = this.value.trim();
                if (value && !isValidUrl(value)) {
                    this.classList.add('error');
                    errorDiv.textContent = 'Please enter a valid URL';
                } else {
                    this.classList.remove('error');
                    errorDiv.textContent = '';
                }
            });
        }
        function generateCtaSections(count) {
            const container = document.getElementById('ctaSections');
            container.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const ctaHtml = `
                    <div class="cta-section">
                        <h4>CTA ${i}</h4>
                        <div class="form-group">
                            <label for="ctaText${i}">Button Text:</label>
                            <input type="text" id="ctaText${i}" placeholder="e.g. 'Donate Now', 'Volunteer'">
                        </div>
                        <div class="form-group">
                            <label for="ctaUrl${i}">CTA URL:</label>
                            <input type="text" id="ctaUrl${i}" placeholder="https://example.com/action">
                            <div class="error-message" id="ctaUrl${i}Error"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += ctaHtml;
            }
            for (let i = 1; i <= count; i++) {
                setupUrlValidation(`ctaUrl${i}`, `ctaUrl${i}Error`);
            }
        }
        function generateStorySections(count) {
            const container = document.getElementById('storySections');
            container.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const storyHtml = `
                    <div class="container-section">
                        <h3>Story ${i}:</h3>
                        <div class="form-group">
                            <label for="storyImage${i}">Story Image (JPG or PNG):</label>
                            <div class="file-input-group">
                                <input type="text" id="storyImage${i}" placeholder="Enter image URL or select file">
                                <button type="button" class="file-btn" onclick="triggerFileInput('storyImageFile${i}')">Select File</button>
                                <input type="file" id="storyImageFile${i}" class="hidden-file-input" accept=".jpg,.jpeg,.png">
                            </div>
                            <div class="error-message" id="storyImage${i}Error"></div>
                        </div>
                        <div class="form-group">
                            <label for="storyImageAlt${i}">Image alt:</label>
                            <input type="text" id="storyImageAlt${i}" placeholder="e.g., 'Community members at a peaceful demonstration'">
                        </div>
                        <div class="form-group">
                            <label for="storyHeadline${i}">Headline:</label>
                            <input type="text" id="storyHeadline${i}" placeholder="e.g., 'Local Community Stands Up for Justice'">
                        </div>
                        <div class="form-group">
                            <label for="storyDescription${i}">Description:</label>
                            <input type="text" id="storyDescription${i}" placeholder="e.g., 'Residents organize peaceful protest to demand accountability...'">
                        </div>
                        <div class="form-group">
                            <label for="storyUrl${i}">Story URL:</label>
                            <input type="text" id="storyUrl${i}" placeholder="https://example.com/story">
                            <div class="error-message" id="storyUrl${i}Error"></div>
                        </div>
                    </div>
                `;
                container.innerHTML += storyHtml;
            }
            for (let i = 1; i <= count; i++) {
                setupFileInput(`storyImage${i}`, `storyImageFile${i}`);
                setupUrlValidation(`storyUrl${i}`, `storyUrl${i}Error`);
            }
        }
        document.getElementById('ctaCount').addEventListener('change', function() {
            generateCtaSections(parseInt(this.value));
        });
        document.getElementById('storyCount').addEventListener('change', function() {
            generateStorySections(parseInt(this.value));
        });
        setupFileInput('heroImage', 'heroImageFile');
        setupUrlValidation('learnMoreUrl', 'learnMoreUrlError');
        document.getElementById('newsletterBuildForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            const heroImage = document.getElementById('heroImage').value.trim();
            if (!heroImage) {
                alert('Please provide a hero image');
                return;
            }
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('loadingDiv').style.display = 'block';
            try {
                function getImageData(inputId) {
                    const input = document.getElementById(inputId);
                    const fileData = input.getAttribute('data-file-data');
                    const isFileSelected = input.getAttribute('data-file-selected') === 'true';
                    if (isFileSelected && fileData) {
                        return fileData;
                    } else {
                        return input.value.trim();
                    }
                }
                const heroImageData = getImageData('heroImage');
                const formData = {
                    country: selectedCountry,
                    languages: selectedLanguages ? selectedLanguages.join(',') : '',
                    hero: {
                        image: heroImageData,
                        imageAlt: document.getElementById('heroImageAlt').value.trim(),
                        headline: document.getElementById('heroHeadline').value.trim(),
                        description: document.getElementById('heroDescription').value.trim(),
                        learnMoreUrl: document.getElementById('learnMoreUrl').value.trim()
                    },
                    ctas: [],
                    stories: []
                };
                const ctaCount = parseInt(document.getElementById('ctaCount').value);
                for (let i = 1; i <= ctaCount; i++) {
                    const text = document.getElementById(`ctaText${i}`).value.trim();
                    const url = document.getElementById(`ctaUrl${i}`).value.trim();
                    if (text && url) {
                        formData.ctas.push({ text, url });
                    }
                }
                const storyCount = parseInt(document.getElementById('storyCount').value);
                for (let i = 1; i <= storyCount; i++) {
                    const imageData = getImageData(`storyImage${i}`);
                    const imageAlt = document.getElementById(`storyImageAlt${i}`).value.trim();
                    const headline = document.getElementById(`storyHeadline${i}`).value.trim();
                    const description = document.getElementById(`storyDescription${i}`).value.trim();
                    const url = document.getElementById(`storyUrl${i}`).value.trim();
                    if (imageData && url) {
                        formData.stories.push({ 
                            image: imageData, 
                            imageAlt, 
                            headline, 
                            description, 
                            url 
                        });
                    }
                }
                const response = await fetch('/api/build-newsletter', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(formData)
                });
                const result = await response.json();
                if (response.ok) {
                    if (result.local_files && result.local_files.length > 0) {
                        alert(`Newsletter(s) generated successfully!\n\nGenerated files:\n${result.local_files.join('\n')}`);
                    } else {
                        alert(`${result.message || 'Success'}`);
                    }
                } else {
                    alert(`Error generating newsletter: ${result.error || 'Unknown error'}`);
                }
            } catch (error) {
                console.error('Error generating newsletter:', error);
                alert('Error generating newsletter. Please try again.');
            } finally {
                document.getElementById('generateBtn').disabled = false;
                document.getElementById('loadingDiv').style.display = 'none';
            }
        });
    </script>
</body>
</html>
